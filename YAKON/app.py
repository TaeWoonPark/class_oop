from flask import Flask, render_template, request, jsonify

app = Flask(__name__)

# 腸活タイプの定義
INTESTINE_TYPES = {
    "ストレス型": {
        "description": "ストレスや緊張で腸の動きが悪くなりがちなタイプ",
        "symptoms": ["便秘", "下痢", "腹痛", "お腹の張り", "食欲不振"],
        "advice": [
            "リラックスする時間を作る",
            "深呼吸や瞑想を習慣にする",
            "規則正しい生活リズムを心がける",
            "カフェインやアルコールを控えめにする",
            "適度な運動でストレス発散",
        ],
        "foods": ["バナナ", "ヨーグルト", "玄米", "納豆", "味噌汁"],
    },
    "食生活型": {
        "description": "偏った食生活で腸内環境が乱れがちなタイプ",
        "symptoms": ["便秘", "お腹の張り", "ガスが溜まる", "肌荒れ", "疲労感"],
        "advice": [
            "食物繊維を積極的に摂取する",
            "発酵食品を毎日食べる",
            "水分を十分に摂る",
            "朝食を抜かない",
            "ゆっくりよく噛んで食べる",
        ],
        "foods": ["キムチ", "ぬか漬け", "ヨーグルト", "納豆", "味噌", "野菜"],
    },
    "運動不足型": {
        "description": "運動不足で腸の蠕動運動が弱くなっているタイプ",
        "symptoms": ["便秘", "お腹の張り", "むくみ", "冷え性", "肩こり"],
        "advice": [
            "毎日30分以上のウォーキング",
            "腹筋運動で腸を刺激",
            "ストレッチで血行促進",
            "階段を使う習慣をつける",
            "座りっぱなしを避ける",
        ],
        "foods": ["玄米", "野菜", "果物", "海藻", "きのこ"],
    },
    "睡眠不足型": {
        "description": "睡眠不足で腸のリズムが乱れているタイプ",
        "symptoms": ["便秘", "下痢", "食欲不振", "イライラ", "集中力低下"],
        "advice": [
            "7-8時間の十分な睡眠を取る",
            "就寝前のスマホ使用を控える",
            "朝日を浴びて体内時計をリセット",
            "就寝前のカフェインを避ける",
            "リラックスできる就寝ルーティンを作る",
        ],
        "foods": ["バナナ", "牛乳", "ハーブティー", "ナッツ", "はちみつ"],
    },
    "加齢型": {
        "description": "加齢による腸の機能低下が見られるタイプ",
        "symptoms": ["便秘", "お腹の張り", "食欲不振", "疲労感", "免疫力低下"],
        "advice": [
            "適度な運動で筋力維持",
            "水分を十分に摂取",
            "食物繊維を意識的に摂る",
            "発酵食品で腸内環境改善",
            "定期的な健康診断を受ける",
        ],
        "foods": ["ヨーグルト", "納豆", "味噌", "野菜", "果物", "海藻"],
    },
}

# 診断質問
QUESTIONS = [
    {
        "id": 1,
        "question": "最近のストレスレベルは？",
        "options": [
            {
                "text": "非常に高い",
                "scores": {"ストレス型": 3, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 2, "加齢型": 1},
            },
            {
                "text": "やや高い",
                "scores": {"ストレス型": 2, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "普通",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "低い",
                "scores": {"ストレス型": 0, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
        ],
    },
    {
        "id": 2,
        "question": "1日の運動時間は？",
        "options": [
            {
                "text": "30分以上",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 0, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "15-30分",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "15分未満",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 2, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "ほとんど運動しない",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 3, "睡眠不足型": 1, "加齢型": 1},
            },
        ],
    },
    {
        "id": 3,
        "question": "平均睡眠時間は？",
        "options": [
            {
                "text": "8時間以上",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 0, "加齢型": 1},
            },
            {
                "text": "7-8時間",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 0, "加齢型": 1},
            },
            {
                "text": "6-7時間",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 2, "加齢型": 1},
            },
            {
                "text": "6時間未満",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 3, "加齢型": 1},
            },
        ],
    },
    {
        "id": 4,
        "question": "野菜の摂取頻度は？",
        "options": [
            {
                "text": "毎食食べる",
                "scores": {"ストレス型": 1, "食生活型": 0, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "1日2回",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "1日1回",
                "scores": {"ストレス型": 1, "食生活型": 2, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "ほとんど食べない",
                "scores": {"ストレス型": 1, "食生活型": 3, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
        ],
    },
    {
        "id": 5,
        "question": "発酵食品の摂取頻度は？",
        "options": [
            {
                "text": "毎日食べる",
                "scores": {"ストレス型": 1, "食生活型": 0, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "週3-4回",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "週1-2回",
                "scores": {"ストレス型": 1, "食生活型": 2, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "ほとんど食べない",
                "scores": {"ストレス型": 1, "食生活型": 3, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
        ],
    },
    {
        "id": 6,
        "question": "便秘の頻度は？",
        "options": [
            {
                "text": "ほとんどない",
                "scores": {"ストレス型": 0, "食生活型": 0, "運動不足型": 0, "睡眠不足型": 0, "加齢型": 0},
            },
            {
                "text": "時々ある",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "よくある",
                "scores": {"ストレス型": 2, "食生活型": 2, "運動不足型": 2, "睡眠不足型": 2, "加齢型": 2},
            },
            {
                "text": "常にある",
                "scores": {"ストレス型": 3, "食生活型": 3, "運動不足型": 3, "睡眠不足型": 3, "加齢型": 3},
            },
        ],
    },
    {
        "id": 7,
        "question": "年齢は？",
        "options": [
            {
                "text": "20代以下",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 0},
            },
            {
                "text": "30-40代",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 1},
            },
            {
                "text": "50-60代",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 2},
            },
            {
                "text": "70代以上",
                "scores": {"ストレス型": 1, "食生活型": 1, "運動不足型": 1, "睡眠不足型": 1, "加齢型": 3},
            },
        ],
    },
]


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/questions")
def questions():
    return render_template("questions.html", questions=QUESTIONS)


@app.route("/diagnose", methods=["POST"])
def diagnose():
    data = request.get_json()
    answers = data.get("answers", [])

    # スコア計算
    scores = {type_name: 0 for type_name in INTESTINE_TYPES.keys()}

    for answer in answers:
        question_id = answer["questionId"]
        option_index = answer["optionIndex"]

        if question_id <= len(QUESTIONS) and option_index < len(QUESTIONS[question_id - 1]["options"]):
            option = QUESTIONS[question_id - 1]["options"][option_index]
            for type_name, score in option["scores"].items():
                scores[type_name] += score

    # 最もスコアが高いタイプを特定
    max_score = max(scores.values())
    result_type = [k for k, v in scores.items() if v == max_score][0]

    return jsonify({"result_type": result_type, "type_info": INTESTINE_TYPES[result_type], "scores": scores})


@app.route("/result")
def result():
    return render_template("result.html")


if __name__ == "__main__":
    app.run(debug=True)
